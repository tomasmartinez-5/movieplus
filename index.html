<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ecommerce Pel√≠culas - Tom√°s Mart√≠nez</title>
  <meta name="description" content="Tienda demo de pel√≠culas ‚Äî carrito con Map, persistencia y PayPal sandbox." />

  <style>
    /* =========================
       PALETA: MORADO + BLANCO
       ========================= */
    :root{
      --bg: #faf8ff;           /* fondo general (muy claro) */
      --panel: #3a1f5a;        /* paneles / barra lateral morado oscuro */
      --card: #6a3fa6;         /* tarjetas morado medio */
      --card-2: #7e4fc0;       /* acento */
      --muted: #6b5878;        /* texto secundario morado suave */
      --text: #111014;         /* texto principal */
      --white: #ffffff;
      --accent: #9b6df0;
      --border: rgba(122, 72, 198, 0.18);
      --success: #28a745;
      --danger: #dc3545;
      --info: #0d6efd;
      --shadow: 0 6px 18px rgba(99, 55, 155, 0.12);
      --radius: 12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #fbf8ff 0%, var(--bg) 100%);
      color:var(--text);
      padding:28px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    header{
      display:flex;
      gap:16px;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(90deg, var(--card), var(--card-2));
      color:var(--white);
      padding:18px;
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      margin-bottom:20px;
    }
    header .brand{
      display:flex;flex-direction:column;align-items:flex-start;
    }
    header h1{margin:0;font-size:20px;letter-spacing:0.2px}
    header p{margin:4px 0 0;color:rgba(255,255,255,0.85);font-size:13px}

    .layout{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:20px;
      align-items:start;
    }

    /* PRODUCTOS */
    main{min-height:60vh}
    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      margin:14px 0;
    }
    label{font-size:14px;color:var(--muted)}
    #categoria{
      background:var(--white);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius:10px;
      min-width:180px;
      font-size:14px;
      color:var(--text);
      box-shadow: 0 2px 8px rgba(122,72,198,0.05);
    }

    #productos{
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(220px,1fr));
      gap:16px;
    }

    .producto{
      background:var(--white);
      border-radius:12px;
      padding:12px;
      border:1px solid rgba(0,0,0,0.04);
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow: 0 6px 14px rgba(99,55,155,0.04);
    }
    .producto img{
      width:100%;
      height:240px;
      object-fit:cover;
      border-radius:10px;
      background:linear-gradient(180deg, #f0e9ff, #efe6ff);
    }
    .producto h3{margin:0;font-size:16px;color:var(--card)}
    .producto p{margin:0;color:var(--muted);font-size:14px}
    .producto .meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .button{
      background: linear-gradient(180deg,var(--accent),var(--card));
      border:none;
      color:var(--white);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      transition:transform .12s ease, box-shadow .12s;
    }
    .button:active{transform:translateY(1px)}
    .button[disabled]{opacity:.6;cursor:not-allowed}

    /* CARRITO */
    .carrito{
      background:var(--white);
      border-radius:12px;
      padding:16px;
      border:1px solid rgba(0,0,0,0.04);
      box-shadow: var(--shadow);
      position:sticky;
      top:28px;
      height: fit-content;
    }
    .carrito h2{margin:0 0 6px 0;color:var(--card)}
    #lista-carrito{list-style:none;padding:0;margin:12px 0 0;max-height:320px;overflow:auto}
    #lista-carrito li{
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,#fff,#fbf7ff);
      border:1px solid var(--border);
      font-size:14px;
    }
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{
      background:transparent;border:1px solid rgba(0,0,0,0.06);padding:6px 8px;border-radius:6px;cursor:pointer;
    }
    .remove{background:var(--danger);color:#fff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}

    .totales{margin-top:12px;border-top:1px dashed rgba(0,0,0,0.04);padding-top:12px}
    .totales p{margin:6px 0;color:var(--muted)}
    .totales .total{font-size:18px;color:var(--card);font-weight:700}

    .acciones{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .vaciar{background:var(--danger);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
    .finalizar{background:var(--info);color:#fff;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}

    .pago{margin-top:12px;background:linear-gradient(180deg,#faf7ff,#fff);padding:10px;border-radius:10px;border:1px solid var(--border)}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}

    /* responsive */
    @media (max-width:980px){
      .layout{grid-template-columns:1fr}
      .carrito{position:relative;top:auto}
    }
  </style>
</head>
<body>
  <header role="banner" aria-label="Encabezado de la tienda">
    <div class="brand">
      <h1>Ecommerce Pel√≠culas ‚Äî Tom√°s Mart√≠nez</h1>
      <p>Selecciona, filtra y compra en demo (PayPal sandbox integrado)</p>
    </div>

    <div aria-hidden="true" style="text-align:right">
      <small style="opacity:.9">Dise√±o: paleta morado & blanco</small>
    </div>
  </header>

  <div class="layout">
    <main>
      <div class="controls" role="region" aria-label="Filtros y opciones">
        <label for="categoria">Filtrar por categor√≠a</label>
        <select id="categoria" name="categoria" aria-label="Filtrar por categor√≠a"></select>
      </div>

      <section id="productos" aria-live="polite" aria-busy="false">
        <!-- Productos renderizados din√°micamente -->
      </section>

      <div id="hints-vacios" class="hint" style="display:none"></div>
    </main>

    <aside class="carrito" aria-label="Carrito de compras">
      <h2>üßæ Carrito</h2>
      <p><strong>Productos en carrito: <span id="cantidad-carrito">0</span></strong></p>

      <ul id="lista-carrito" aria-live="polite"></ul>

      <div class="totales" aria-hidden="false">
        <p>Subtotal: <strong id="subtotal-text">$0.00</strong></p>
        <p>Descuento: <strong id="descuento-text">$0.00</strong></p>
        <p>Impuestos: <strong id="impuestos-text">$0.00</strong></p>
        <p class="total">Total: <strong id="total-text">$0.00</strong></p>
      </div>

      <div class="acciones">
        <button id="btn-vaciar" class="vaciar" type="button">üßº Vaciar</button>
        <button id="btn-finalizar" class="finalizar" type="button">‚úÖ Finalizar</button>
      </div>

      <div class="pago" aria-live="polite">
        <h3>üí≥ M√©todo de pago</h3>
        <div id="paypal-button-container" style="margin-top:10px; display:none;"></div>
        <p class="hint">‚ö†Ô∏è PayPal sandbox: se usa client-id de pruebas (sb). Cambia por tu client-id real cuando publiques.</p>
      </div>
    </aside>
  </div>

  <!-- PayPal SDK (sandbox por defecto). Cambia "sb" por tu client-id de pruebas/producci√≥n -->
  <script src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD&components=buttons,funding-eligibility"></script>

  <script>
    /* =========================
       CONFIG: moneda, locale y reglas
       ========================= */
    const MONEDA = 'USD';   // 'USD' o 'COP' (ajusta si quieres otra)
    const LOCALE = 'es-CO'; // formato num√©rico (puedes cambiar a 'es-ES' o 'en-US')
    const TAX_RATE = 0.00;  // ejemplo: 0.19 para 19% IVA
    const DISCOUNT = 0.00;  // descuento fijo (mantener 0 si no aplica)

    /* =========================
       DATASET: Mantengo exactamente las im√°genes que enviaste
       Cada producto requiere: id, nombre, precio (Number), categoria, img (ruta)
       ========================= */
    const productos = [
      {
        id: 1,
        nombre: "Interestellar",
        precio: 25.00,
        categoria: "Ciencia Ficci√≥n",
        img: "https://img-cdn.publive.online/fit-in/1280x960/filters:format(webp)/socialketchup/media/media_files/2025/02/13/2ESgmicZUwm1lPNNm0RK.jpg"
      },
      {
        id: 2,
        nombre: "La La Land",
        precio: 18.00,
        categoria: "Musical",
        img: "https://seventhartstudio.com/wp-content/uploads/2017/02/La-La-Land-Image-768x432.jpg"
      },
      {
        id: 3,
        nombre: "Scarface",
        precio: 30.00,
        categoria: "Crimen",
        img: "https://www.lanacion.cl/~wwlana/wp-content/uploads/2021/05/2cc84249-scarface.jpg"
      },
      {
        id: 4,
        nombre: "Fight club",
        precio: 18.00,
        categoria: "Drama",
        img: "https://www.radioacktiva.com/wp-content/uploads/2024/09/Plantilla-imagen-notas-89.png"
      },
      {
        id: 5,
        nombre: "The Godfather",
        precio: 22.00,
        categoria: "Crimen",
        img: "https://mshanken.imgix.net/cao/bolt/2022-03/1647463313_godfather0422.jpg?w=900&q=72"
      }
    ];

    /* =========================
       ESTADO + SELECTORES
       ========================= */
    let carrito = new Map(); // estructura requerida
    const el = {
      contProds: document.getElementById('productos'),
      lista: document.getElementById('lista-carrito'),
      subtotal: document.getElementById('subtotal-text'),
      impuestos: document.getElementById('impuestos-text'),
      descuento: document.getElementById('descuento-text'),
      total: document.getElementById('total-text'),
      cantidad: document.getElementById('cantidad-carrito'),
      select: document.getElementById('categoria'),
      btnVaciar: document.getElementById('btn-vaciar'),
      btnFinal: document.getElementById('btn-finalizar'),
      paypal: document.getElementById('paypal-button-container'),
      hints: document.getElementById('hints-vacios')
    };

    const money = new Intl.NumberFormat(LOCALE, { style: 'currency', currency: MONEDA });

    /* =========================
       UTIL: obtener categor√≠as √∫nicas y llenar select
       ========================= */
    function poblarCategorias(){
      const cats = Array.from(new Set(productos.map(p => p.categoria))).filter(Boolean);
      // Limpiar y a√±adir opci√≥n "Todos"
      el.select.innerHTML = '';
      const optTodos = document.createElement('option');
      optTodos.value = 'todos';
      optTodos.textContent = 'Todos';
      el.select.appendChild(optTodos);

      cats.forEach(c => {
        const o = document.createElement('option');
        o.value = c;
        o.textContent = c;
        el.select.appendChild(o);
      });

      // Restaurar filtro guardado si existe
      const guardado = localStorage.getItem('filtro_categoria');
      if (guardado) el.select.value = guardado;
    }

    /* =========================
       RENDER PRODUCTOS
       ========================= */
    function renderProductos(lista){
      el.contProds.setAttribute('aria-busy','true');
      el.contProds.innerHTML = '';

      if (!Array.isArray(lista) || lista.length === 0){
        el.hints.style.display = 'block';
        el.hints.innerHTML = 'üëã No hay productos para mostrar. Edita el array <code>productos</code> en el script para agregar √≠tems.';
        el.contProds.setAttribute('aria-busy','false');
        return;
      } else {
        el.hints.style.display = 'none';
      }

      lista.forEach(p => {
        const card = document.createElement('article');
        card.className = 'producto';
        card.innerHTML = `
          <img src="${p.img}" alt="${p.nombre}">
          <h3>${p.nombre}</h3>
          <p class="meta"><span>${p.categoria}</span><strong>${money.format(Number(p.precio)||0)}</strong></p>
          <div style="margin-top:auto">
            <button class="button" data-add="${p.id}" type="button">Agregar al carrito</button>
          </div>
        `;
        // Manejo de error en imagen (mantengo rutas originales, si falla muestro placeholder)
        const img = card.querySelector('img');
        img.addEventListener('error', () => {
          img.src = 'https://via.placeholder.com/400x600?text=Imagen+no+disponible';
          img.alt = p.nombre + ' (imagen no disponible)';
        });
        el.contProds.appendChild(card);
      });

      el.contProds.setAttribute('aria-busy','false');
    }

    /* =========================
       FILTRO
       ========================= */
    function filtrar(){
      const sel = el.select.value;
      const data = sel === 'todos' ? productos : productos.filter(p => String(p.categoria) === sel);
      renderProductos(data);
      localStorage.setItem('filtro_categoria', sel);
    }

    /* =========================
       PERSISTENCIA (localStorage)
       ========================= */
    function persist(){ localStorage.setItem('carrito', JSON.stringify(Array.from(carrito.entries()))); }
    function load(){
      const data = localStorage.getItem('carrito');
      if (data){
        try {
          carrito = new Map(JSON.parse(data));
        } catch(e){
          console.warn('Error al cargar carrito desde localStorage:', e);
          carrito = new Map();
        }
      }
    }

    /* =========================
       TOTALES
       ========================= */
    function totales(){
      const subtotal = [...carrito.values()].reduce((a,i) => a + Number(i.precio||0) * Number(i.cantidad||0), 0);
      const descuento = Math.min(DISCOUNT, subtotal);
      const base = subtotal - descuento;
      const impuestos = +(base * TAX_RATE).toFixed(2);
      const total = +(base + impuestos).toFixed(2);
      const cantidad = [...carrito.values()].reduce((a,i)=> a + Number(i.cantidad||0), 0);
      return { subtotal, descuento, impuestos, total, cantidad };
    }

    /* =========================
       PINTAR CARRITO
       ========================= */
    let paypalRenderedTotal = null;
    function pintarCarrito(){
      el.lista.innerHTML = '';
      if (carrito.size === 0){
        const li = document.createElement('li');
        li.textContent = 'El carrito est√° vac√≠o.';
        li.style.opacity = '0.8';
        el.lista.appendChild(li);
      } else {
        carrito.forEach(item => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div style="display:flex;flex-direction:column;gap:4px;max-width:60%">
              <strong style="color:var(--card)">${item.nombre}</strong>
              <small style="color:var(--muted)">${money.format(item.precio)} c/u</small>
            </div>
            <div class="qty" role="group" aria-label="Controles cantidad">
              <button aria-label="Disminuir" data-dec="${item.id}">‚àí</button>
              <span aria-live="polite" style="min-width:20px;text-align:center">${item.cantidad}</span>
              <button aria-label="Aumentar" data-inc="${item.id}">+</button>
              <button class="remove" aria-label="Eliminar" data-del="${item.id}">‚ùå</button>
            </div>
          `;
          el.lista.appendChild(li);
        });
      }

      const { subtotal, descuento, impuestos, total, cantidad } = totales();
      el.subtotal.textContent = money.format(subtotal);
      el.descuento.textContent = money.format(descuento);
      el.impuestos.textContent = money.format(impuestos);
      el.total.textContent = money.format(total);
      el.cantidad.textContent = cantidad;

      // Mostrar u ocultar PayPal seg√∫n total
      el.paypal.style.display = total > 0 ? 'block' : 'none';
      renderPayPal(total);
    }

    /* =========================
       FUNCIONES DEL CARRITO (Map)
       ========================= */
    function add(id){
      const p = productos.find(x => x.id === id);
      if (!p) return alert('Producto no encontrado. Revisa el array "productos".');
      const it = carrito.get(id);
      if (it) {
        it.cantidad = Number(it.cantidad) + 1;
        carrito.set(id, it);
      } else {
        carrito.set(id, { ...p, cantidad: 1 });
      }
      persist(); pintarCarrito();
    }

    function dec(id){
      const it = carrito.get(id);
      if (!it) return;
      it.cantidad = Number(it.cantidad) - 1;
      if (it.cantidad <= 0) carrito.delete(id);
      else carrito.set(id, it);
      persist(); pintarCarrito();
    }

    function del(id){
      carrito.delete(id);
      persist(); pintarCarrito();
    }

    /* =========================
       PAYPAL: render condicional
       ========================= */
    function renderPayPal(total){
      if (!window.paypal) return;
      if (total <= 0) {
        paypalRenderedTotal = null;
        el.paypal.innerHTML = '';
        return;
      }
      // Evitar re-render innecesario si el mismo total ya est√° renderizado
      if (paypalRenderedTotal === total && el.paypal.childElementCount > 0) return;
      paypalRenderedTotal = total;
      el.paypal.innerHTML = '';
      paypal.Buttons({
        style: { layout: 'vertical' },
        createOrder: (data, actions) => {
          return actions.order.create({
            purchase_units: [{ amount: { value: total.toFixed(2), currency_code: MONEDA } }]
          });
        },
        onApprove: (data, actions) => {
          return actions.order.capture().then(details => {
            const name = details?.payer?.name?.given_name || 'cliente';
            alert(`üéâ ¬°Gracias ${name}! Pago aprobado (sandbox).`);
            carrito.clear(); persist(); pintarCarrito();
          });
        },
        onError: (err) => {
          console.error('PayPal error', err);
          alert('Error en el proceso de pago. Reintenta.');
        }
      }).render('#paypal-button-container');
    }

    /* =========================
       EVENTOS (delegados)
       ========================= */
    document.addEventListener('click', (e) => {
      const addBtn = e.target.closest('[data-add]');
      if (addBtn) { add(+addBtn.dataset.add); return; }

      const incBtn = e.target.closest('[data-inc]');
      if (incBtn) { add(+incBtn.dataset.inc); return; }

      const decBtn = e.target.closest('[data-dec]');
      if (decBtn) { dec(+decBtn.dataset.dec); return; }

      const delBtn = e.target.closest('[data-del]');
      if (delBtn) { del(+delBtn.dataset.del); return; }
    });

    el.select.addEventListener('change', filtrar);

    el.btnVaciar.addEventListener('click', () => {
      if (carrito.size === 0) return alert('El carrito ya est√° vac√≠o.');
      if (confirm('¬øVaciar carrito?')) {
        carrito.clear(); persist(); pintarCarrito();
      }
    });

    el.btnFinal.addEventListener('click', () => {
      if (carrito.size === 0) return alert('Carrito vac√≠o. Agrega productos antes de finalizar.');
      // Simulaci√≥n de finalizaci√≥n (en entorno real, integrar backend o usar PayPal)
      if (confirm('Simular finalizaci√≥n de compra (sandbox). ¬øConfirmar pedido?')) {
        alert('Pedido confirmado (simulaci√≥n). Gracias por comprar.');
        carrito.clear(); persist(); pintarCarrito();
      }
    });

    /* =========================
       INICIALIZACI√ìN
       ========================= */
    (function init(){
      poblarCategorias();
      // Aplicar filtro guardado al cargar
      const f = localStorage.getItem('filtro_categoria') || 'todos';
      el.select.value = f;
      filtrar();

      load();
      pintarCarrito();

      // Accesibilidad: focus al main
      document.querySelector('main')?.focus?.();
    })();
  </script>
</body>
</html>
